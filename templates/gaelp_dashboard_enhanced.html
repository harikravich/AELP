<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAELP Enhanced Dashboard - ALL 19 Components</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ccc;
        }
        
        .status-dot.active {
            background: #4CAF50;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-start {
            background: #4CAF50;
            color: white;
        }
        
        .btn-stop {
            background: #f44336;
            color: white;
        }
        
        .btn-reset {
            background: #FF9800;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .metric-card h3 {
            color: #667eea;
            font-size: 14px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }
        
        .metric-change {
            font-size: 14px;
            color: #4CAF50;
            margin-top: 5px;
        }
        
        .metric-change.negative {
            color: #f44336;
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .chart-container h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .components-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        
        .component-status {
            background: white;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .component-status.active {
            border-left: 4px solid #4CAF50;
        }
        
        .component-name {
            font-size: 12px;
            font-weight: 600;
            flex: 1;
        }
        
        .component-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
        }
        
        .event-log {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .event-log h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .event-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .event-time {
            color: #999;
            font-size: 11px;
        }
        
        .event-icon {
            font-size: 16px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .segment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .learning-insights {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        
        .insight-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }
        
        .insight-card h4 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .leaderboard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        
        .channel-leaderboard {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
        }
        
        .channel-leaderboard h4 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .leaderboard-table th,
        .leaderboard-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .leaderboard-table th {
            color: #667eea;
            font-weight: 600;
        }
        
        .clusters-container {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }
        
        .cluster-visualization {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
        }
        
        .cluster-details,
        .cluster-stats {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
        }
        
        .cluster-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .cluster-table th,
        .cluster-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .segment-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .segment-card h4 {
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .segment-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .segment-stat {
            font-size: 12px;
        }
        
        .segment-stat-value {
            font-size: 18px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 GAELP Enhanced Dashboard - ALL 19 Components Active</h1>
            <div class="subtitle">Real-time Ad Campaign Optimization with NO FALLBACKS</div>
            
            <div class="status-bar">
                <div class="status-indicator">
                    <span class="status-dot" id="systemStatus"></span>
                    <span id="systemStatusText">System Offline</span>
                </div>
                <div class="status-indicator">
                    <span>Episode:</span>
                    <strong id="episodeCount">0</strong>
                </div>
                <div class="status-indicator">
                    <span>Win Rate:</span>
                    <strong id="winRate">0%</strong>
                </div>
                <div class="status-indicator">
                    <span>ROI:</span>
                    <strong id="currentROI">0%</strong>
                </div>
                <div class="status-indicator">
                    <span>Daily Spend:</span>
                    <strong id="dailySpend">$0</strong>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn btn-start" onclick="startSystem()">▶️ Start</button>
                <button class="btn btn-stop" onclick="stopSystem()">⏹️ Stop</button>
                <button class="btn btn-reset" onclick="resetSystem()">🔄 Reset</button>
            </div>
        </div>
        
        <!-- Component Status Grid -->
        <div class="chart-container">
            <h3>19 Component Status</h3>
            <div class="components-grid" id="componentsGrid">
                <!-- Will be populated dynamically -->
            </div>
        </div>
        
        <!-- Main Metrics -->
        <div class="dashboard-grid">
            <div class="metric-card">
                <h3>Total Impressions</h3>
                <div class="metric-value" id="totalImpressions">0</div>
                <div class="metric-change" id="impressionsChange">+0%</div>
            </div>
            
            <div class="metric-card">
                <h3>Total Clicks</h3>
                <div class="metric-value" id="totalClicks">0</div>
                <div class="metric-change" id="clicksChange">+0%</div>
            </div>
            
            <div class="metric-card">
                <h3>Total Conversions</h3>
                <div class="metric-value" id="totalConversions">0</div>
                <div class="metric-change" id="conversionsChange">+0%</div>
            </div>
            
            <div class="metric-card">
                <h3>Delayed Conversions</h3>
                <div class="metric-value" id="delayedConversions">0</div>
                <div class="metric-change">Pending: <span id="pendingConversions">0</span></div>
            </div>
            
            <div class="metric-card">
                <h3>CPA</h3>
                <div class="metric-value" id="currentCPA">$0</div>
                <div class="metric-change" id="cpaChange">Target: $50</div>
            </div>
            
            <div class="metric-card">
                <h3>Total Revenue</h3>
                <div class="metric-value" id="totalRevenue">$0</div>
                <div class="metric-change" id="revenueChange">+0%</div>
            </div>
        </div>
        
        <!-- Tabs for different views -->
        <div class="chart-container">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('performance')">Performance</div>
                <div class="tab" onclick="switchTab('rl')">RL Agent</div>
                <div class="tab" onclick="switchTab('competitors')">Competitors</div>
                <div class="tab" onclick="switchTab('channels')">Channels</div>
                <div class="tab" onclick="switchTab('segments')">Segments</div>
                <div class="tab" onclick="switchTab('learning')">Learning Insights</div>
                <div class="tab" onclick="switchTab('creative')">Creative Leaderboard</div>
                <div class="tab" onclick="switchTab('clusters')">Discovered Clusters</div>
            </div>
            
            <!-- Performance Tab -->
            <div class="tab-content active" id="performanceTab">
                <h3>Real-time Performance Metrics</h3>
                <canvas id="performanceChart"></canvas>
            </div>
            
            <!-- RL Agent Tab -->
            <div class="tab-content" id="rlTab">
                <h3>RL Agent Q-Values & Learning</h3>
                <canvas id="rlChart"></canvas>
                <div style="margin-top: 20px;">
                    <p>Learning Episodes: <strong id="learningEpisodes">0</strong></p>
                    <p>Exploration Rate: <strong id="explorationRate">10%</strong></p>
                    <p>Average Reward: <strong id="avgReward">0</strong></p>
                </div>
            </div>
            
            <!-- Competitors Tab -->
            <div class="tab-content" id="competitorsTab">
                <h3>Competitive Intelligence</h3>
                <canvas id="competitorChart"></canvas>
            </div>
            
            <!-- Channels Tab -->
            <div class="tab-content" id="channelsTab">
                <h3>Multi-Channel Performance</h3>
                <canvas id="channelChart"></canvas>
            </div>
            
            <!-- Segments Tab -->
            <div class="tab-content" id="segmentsTab">
                <h3>Segment Performance</h3>
                <div class="segment-grid" id="segmentGrid">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
            
            <!-- Learning Insights Tab -->
            <div class="tab-content" id="learningTab">
                <h3>RL Agent Learning Insights</h3>
                <div class="learning-insights">
                    <div class="insight-card">
                        <h4>Discovered Patterns</h4>
                        <ul id="discoveredPatterns"></ul>
                    </div>
                    <div class="insight-card">
                        <h4>Bid Strategy Evolution</h4>
                        <canvas id="bidStrategyChart"></canvas>
                    </div>
                    <div class="insight-card">
                        <h4>Top Performing Strategies</h4>
                        <ul id="topStrategies"></ul>
                    </div>
                </div>
            </div>
            
            <!-- Creative Leaderboard Tab -->
            <div class="tab-content" id="creativeTab">
                <h3>Creative Performance Leaderboard</h3>
                <div class="leaderboard-container">
                    <div class="channel-leaderboard" id="googleLeaderboard">
                        <h4>Google Ads</h4>
                        <table class="leaderboard-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Creative</th>
                                    <th>CTR</th>
                                    <th>Impressions</th>
                                    <th>Clicks</th>
                                </tr>
                            </thead>
                            <tbody id="googleCreatives"></tbody>
                        </table>
                    </div>
                    <div class="channel-leaderboard" id="facebookLeaderboard">
                        <h4>Facebook Ads</h4>
                        <table class="leaderboard-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Creative</th>
                                    <th>CTR</th>
                                    <th>Impressions</th>
                                    <th>Clicks</th>
                                </tr>
                            </thead>
                            <tbody id="facebookCreatives"></tbody>
                        </table>
                    </div>
                    <div class="channel-leaderboard" id="tiktokLeaderboard">
                        <h4>TikTok Ads</h4>
                        <table class="leaderboard-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Creative</th>
                                    <th>CTR</th>
                                    <th>Impressions</th>
                                    <th>Clicks</th>
                                </tr>
                            </thead>
                            <tbody id="tiktokCreatives"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Discovered Clusters Tab -->
            <div class="tab-content" id="clustersTab">
                <h3>Dynamically Discovered Clusters</h3>
                <div class="clusters-container">
                    <div class="cluster-visualization">
                        <canvas id="clusterChart"></canvas>
                    </div>
                    <div class="cluster-details">
                        <h4>Discovered Segments</h4>
                        <div id="clusterList"></div>
                    </div>
                    <div class="cluster-stats">
                        <h4>Cluster Performance</h4>
                        <table class="cluster-table">
                            <thead>
                                <tr>
                                    <th>Cluster</th>
                                    <th>Size</th>
                                    <th>Conv Rate</th>
                                    <th>Avg LTV</th>
                                </tr>
                            </thead>
                            <tbody id="clusterStats"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Additional Charts -->
        <div class="dashboard-grid">
            <div class="chart-container">
                <h3>Conversion Lag Analysis</h3>
                <canvas id="conversionLagChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>Attribution Model</h3>
                <canvas id="attributionChart"></canvas>
            </div>
        </div>
        
        <!-- Event Log -->
        <div class="event-log">
            <h3>Live Event Log</h3>
            <div id="eventLog"></div>
        </div>
    </div>
    
    <script>
        let charts = {};
        let updateInterval = null;
        
        // Initialize all charts
        function initCharts() {
            // Performance Chart
            const perfCtx = document.getElementById('performanceChart').getContext('2d');
            charts.performance = new Chart(perfCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'ROI %',
                            data: [],
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Win Rate %',
                            data: [],
                            borderColor: '#2196F3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Bid ($)',
                            data: [],
                            borderColor: '#FF9800',
                            backgroundColor: 'rgba(255, 152, 0, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                        },
                    }
                }
            });
            
            // RL Agent Chart
            const rlCtx = document.getElementById('rlChart').getContext('2d');
            charts.rl = new Chart(rlCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Q-Values',
                            data: [],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Delayed Rewards',
                            data: [],
                            borderColor: '#764ba2',
                            backgroundColor: 'rgba(118, 75, 162, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true
                }
            });
            
            // Competitor Chart
            const compCtx = document.getElementById('competitorChart').getContext('2d');
            charts.competitor = new Chart(compCtx, {
                type: 'bar',
                data: {
                    labels: ['Our Bids', 'Competitor 1', 'Competitor 2', 'Competitor 3'],
                    datasets: [{
                        label: 'Average Bid',
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#4CAF50', '#f44336', '#FF9800', '#2196F3']
                    }]
                },
                options: {
                    responsive: true
                }
            });
            
            // Channel Chart
            const channelCtx = document.getElementById('channelChart').getContext('2d');
            charts.channel = new Chart(channelCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Google', 'Facebook', 'Bing'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#4285F4', '#1877F2', '#00897B']
                    }]
                },
                options: {
                    responsive: true
                }
            });
            
            // Conversion Lag Chart
            const lagCtx = document.getElementById('conversionLagChart').getContext('2d');
            charts.conversionLag = new Chart(lagCtx, {
                type: 'bar',
                data: {
                    labels: ['0-1h', '1-6h', '6-24h', '1-3d', '3-7d', '7d+'],
                    datasets: [{
                        label: 'Conversions',
                        data: [0, 0, 0, 0, 0, 0],
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true
                }
            });
            
            // Attribution Chart
            const attrCtx = document.getElementById('attributionChart').getContext('2d');
            charts.attribution = new Chart(attrCtx, {
                type: 'pie',
                data: {
                    labels: ['First Touch', 'Last Touch', 'Multi-Touch', 'Data-Driven'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#4CAF50', '#f44336', '#FF9800', '#2196F3']
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }
        
        // Switch tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }
        
        // Update dashboard
        async function updateDashboard() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // Update metrics
                document.getElementById('totalImpressions').textContent = data.metrics.total_impressions;
                document.getElementById('totalClicks').textContent = data.metrics.total_clicks;
                document.getElementById('totalConversions').textContent = data.metrics.total_conversions;
                document.getElementById('totalRevenue').textContent = `$${data.metrics.total_revenue.toFixed(2)}`;
                document.getElementById('currentCPA').textContent = `$${data.metrics.current_cpa.toFixed(2)}`;
                document.getElementById('currentROI').textContent = `${(data.metrics.current_roi * 100).toFixed(1)}%`;
                document.getElementById('winRate').textContent = `${(data.metrics.win_rate * 100).toFixed(1)}%`;
                document.getElementById('dailySpend').textContent = `$${data.metrics.total_spend.toFixed(2)}`;
                
                // Update delayed conversions
                if (data.component_tracking && data.component_tracking.delayed_rewards) {
                    document.getElementById('delayedConversions').textContent = 
                        data.component_tracking.delayed_rewards.realized_conversions;
                    document.getElementById('pendingConversions').textContent = 
                        data.component_tracking.delayed_rewards.pending_conversions;
                }
                
                // Update RL stats
                if (data.rl_stats) {
                    document.getElementById('learningEpisodes').textContent = data.rl_stats.learning_episodes || 0;
                    document.getElementById('explorationRate').textContent = 
                        `${(data.rl_stats.exploration_rate * 100).toFixed(1)}%`;
                    document.getElementById('avgReward').textContent = 
                        data.rl_stats.average_reward?.toFixed(2) || '0';
                }
                
                // Update component status
                if (data.component_status) {
                    const grid = document.getElementById('componentsGrid');
                    grid.innerHTML = '';
                    for (const [name, status] of Object.entries(data.component_status)) {
                        const div = document.createElement('div');
                        div.className = `component-status ${status}`;
                        div.innerHTML = `
                            <span class="component-name">${name.replace(/_/g, ' ')}</span>
                            <span class="component-indicator"></span>
                        `;
                        grid.appendChild(div);
                    }
                }
                
                // Update charts
                if (data.time_series && data.time_series.timestamps.length > 0) {
                    const labels = data.time_series.timestamps.slice(-20).map(ts => 
                        new Date(ts).toLocaleTimeString()
                    );
                    
                    // Performance chart
                    charts.performance.data.labels = labels;
                    charts.performance.data.datasets[0].data = data.time_series.roi.slice(-20);
                    charts.performance.data.datasets[1].data = data.time_series.win_rate.slice(-20).map(v => v * 100);
                    charts.performance.data.datasets[2].data = data.time_series.bids.slice(-20);
                    charts.performance.update();
                    
                    // RL chart
                    charts.rl.data.labels = labels;
                    charts.rl.data.datasets[0].data = data.time_series.q_values.slice(-20);
                    charts.rl.data.datasets[1].data = data.time_series.delayed_rewards.slice(-20);
                    charts.rl.update();
                }
                
                // Update channel chart
                if (data.component_tracking && data.component_tracking.channels) {
                    const channels = data.component_tracking.channels;
                    charts.channel.data.datasets[0].data = [
                        channels.google?.spend || 0,
                        channels.facebook?.spend || 0,
                        channels.bing?.spend || 0
                    ];
                    charts.channel.update();
                }
                
                // Update attribution chart
                if (data.component_tracking && data.component_tracking.attribution) {
                    const attr = data.component_tracking.attribution;
                    charts.attribution.data.datasets[0].data = [
                        attr.first_touch || 0,
                        attr.last_touch || 0,
                        attr.multi_touch || 0,
                        attr.data_driven || 0
                    ];
                    charts.attribution.update();
                }
                
                // Update competitor chart
                if (data.competitors) {
                    const competitorData = [
                        data.metrics.average_bid || 0,
                        0, 0, 0  // Default values for competitors
                    ];
                    
                    // Extract competitor bids if available
                    const competitorNames = Object.keys(data.competitors);
                    competitorNames.slice(0, 3).forEach((name, idx) => {
                        competitorData[idx + 1] = data.competitors[name].avg_bid || 0;
                    });
                    
                    charts.competitor.data.datasets[0].data = competitorData;
                    charts.competitor.update();
                }
                
                // Update segments
                if (data.segment_performance) {
                    const segmentGrid = document.getElementById('segmentGrid');
                    segmentGrid.innerHTML = '';
                    for (const [name, stats] of Object.entries(data.segment_performance)) {
                        const card = document.createElement('div');
                        card.className = 'segment-card';
                        card.innerHTML = `
                            <h4>${name.replace(/_/g, ' ').toUpperCase()}</h4>
                            <div class="segment-stats">
                                <div class="segment-stat">
                                    <div>Impressions</div>
                                    <div class="segment-stat-value">${stats.impressions}</div>
                                </div>
                                <div class="segment-stat">
                                    <div>Clicks</div>
                                    <div class="segment-stat-value">${stats.clicks}</div>
                                </div>
                                <div class="segment-stat">
                                    <div>Conversions</div>
                                    <div class="segment-stat-value">${stats.conversions}</div>
                                </div>
                                <div class="segment-stat">
                                    <div>Revenue</div>
                                    <div class="segment-stat-value">$${stats.revenue.toFixed(2)}</div>
                                </div>
                            </div>
                        `;
                        segmentGrid.appendChild(card);
                    }
                }
                
                // Update Learning Insights
                if (data.learning_insights) {
                    // Update discovered patterns
                    const patternsEl = document.getElementById('discoveredPatterns');
                    if (patternsEl && data.learning_insights.discovered_patterns) {
                        patternsEl.innerHTML = '';
                        data.learning_insights.discovered_patterns.forEach(pattern => {
                            const li = document.createElement('li');
                            li.textContent = pattern;
                            patternsEl.appendChild(li);
                        });
                    }
                    
                    // Update top strategies
                    const strategiesEl = document.getElementById('topStrategies');
                    if (strategiesEl && data.learning_insights.top_strategies) {
                        strategiesEl.innerHTML = '';
                        data.learning_insights.top_strategies.forEach(strategy => {
                            const li = document.createElement('li');
                            li.textContent = strategy;
                            strategiesEl.appendChild(li);
                        });
                    }
                    
                    // Update creative leaderboards
                    if (data.learning_insights.creative_leaderboard) {
                        ['google', 'facebook', 'tiktok'].forEach(channel => {
                            const tbody = document.getElementById(`${channel}Creatives`);
                            if (tbody && data.learning_insights.creative_leaderboard[channel]) {
                                tbody.innerHTML = '';
                                data.learning_insights.creative_leaderboard[channel].forEach((creative, idx) => {
                                    const tr = document.createElement('tr');
                                    tr.innerHTML = `
                                        <td>${idx + 1}</td>
                                        <td>${creative.message}</td>
                                        <td>${(creative.ctr * 100).toFixed(2)}%</td>
                                        <td>${creative.impressions}</td>
                                        <td>${creative.clicks}</td>
                                    `;
                                    tbody.appendChild(tr);
                                });
                            }
                        });
                    }
                    
                    // Update discovered clusters
                    const clusterListEl = document.getElementById('clusterList');
                    if (clusterListEl && data.learning_insights.discovered_clusters) {
                        clusterListEl.innerHTML = '';
                        data.learning_insights.discovered_clusters.forEach(cluster => {
                            const div = document.createElement('div');
                            div.className = 'cluster-item';
                            div.innerHTML = `<strong>${cluster.name}</strong>: ${cluster.description}`;
                            clusterListEl.appendChild(div);
                        });
                    }
                    
                    // Update cluster stats
                    const clusterStatsEl = document.getElementById('clusterStats');
                    if (clusterStatsEl && data.learning_insights.cluster_performance) {
                        clusterStatsEl.innerHTML = '';
                        data.learning_insights.cluster_performance.forEach(cluster => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${cluster.name}</td>
                                <td>${cluster.size}</td>
                                <td>${(cluster.conv_rate * 100).toFixed(2)}%</td>
                                <td>$${cluster.avg_ltv.toFixed(2)}</td>
                            `;
                            clusterStatsEl.appendChild(tr);
                        });
                    }
                }
                
                // Update event log
                if (data.events) {
                    const eventLog = document.getElementById('eventLog');
                    eventLog.innerHTML = '';
                    data.events.reverse().forEach(event => {
                        const div = document.createElement('div');
                        div.className = 'event-item';
                        div.innerHTML = `
                            <span class="event-icon">${event.message.substring(0, 2)}</span>
                            <span>${event.message.substring(2)}</span>
                            <span class="event-time">${new Date(event.timestamp).toLocaleTimeString()}</span>
                        `;
                        eventLog.appendChild(div);
                    });
                }
                
                // Update system status
                const statusDot = document.getElementById('systemStatus');
                const statusText = document.getElementById('systemStatusText');
                if (data.metrics.total_impressions > 0) {
                    statusDot.classList.add('active');
                    statusText.textContent = 'System Active';
                } else {
                    statusDot.classList.remove('active');
                    statusText.textContent = 'System Idle';
                }
                
            } catch (error) {
                console.error('Error updating dashboard:', error);
            }
        }
        
        // Control functions
        async function startSystem() {
            await fetch('/api/start', { method: 'POST' });
            if (!updateInterval) {
                updateInterval = setInterval(updateDashboard, 1000);
            }
        }
        
        async function stopSystem() {
            await fetch('/api/stop', { method: 'POST' });
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
        }
        
        async function resetSystem() {
            await fetch('/api/reset', { method: 'POST' });
            updateDashboard();
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            updateDashboard();
            // Start auto-update
            updateInterval = setInterval(updateDashboard, 1000);
        });
    </script>
</body>
</html>