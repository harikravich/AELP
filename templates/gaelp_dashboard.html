<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAELP Live System - Aura Parental Controls</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-dot.running {
            background: #48bb78;
        }
        
        .status-dot.stopped {
            background: #f56565;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .controls {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-start {
            background: #48bb78;
            color: white;
        }
        
        .btn-stop {
            background: #f56565;
            color: white;
        }
        
        .btn-reset {
            background: #ed8936;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .metric-card h3 {
            color: #718096;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 5px;
        }
        
        .metric-change {
            font-size: 12px;
            color: #718096;
        }
        
        .metric-change.positive {
            color: #48bb78;
        }
        
        .metric-change.negative {
            color: #f56565;
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .chart-container h3 {
            color: #2d3748;
            margin-bottom: 15px;
        }
        
        .segments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .segment-card {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e2e8f0;
        }
        
        .segment-name {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .segment-stat {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 14px;
        }
        
        .thompson-arms {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .arm-card {
            background: #f7fafc;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .arm-name {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 10px;
        }
        
        .arm-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }
        
        .arm-bar {
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .arm-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
        }
        
        .event-log {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            max-height: 300px;
            overflow-y: auto;
        }
        
        .event-log h3 {
            color: #2d3748;
            margin-bottom: 15px;
        }
        
        .event-item {
            padding: 8px;
            margin: 5px 0;
            border-left: 3px solid #e2e8f0;
            font-size: 14px;
        }
        
        .event-item.success {
            border-left-color: #48bb78;
            background: #48bb7810;
        }
        
        .event-item.error {
            border-left-color: #f56565;
            background: #f5656510;
        }
        
        .event-item.conversion {
            border-left-color: #f6ad55;
            background: #f6ad5510;
        }
        
        .event-item.learning {
            border-left-color: #667eea;
            background: #667eea10;
        }
        
        .event-time {
            color: #a0aec0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ GAELP Live System - Aura Parental Controls</h1>
            <div class="status-bar">
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Initializing...</span>
                    <span id="episodeCount" style="margin-left: 20px; color: #718096;">Episode: 0</span>
                </div>
                <div class="controls">
                    <button class="btn btn-start" onclick="startSystem()">‚ñ∂Ô∏è Start</button>
                    <button class="btn btn-stop" onclick="stopSystem()">‚èπÔ∏è Stop</button>
                    <button class="btn btn-reset" onclick="resetSystem()">üîÑ Reset</button>
                </div>
            </div>
        </div>
        
        <!-- Primary CAC Card - Prominent Display -->
        <div class="metric-card" style="grid-column: span 2; background: linear-gradient(135deg, #f6ad55 0%, #f56565 100%); color: white;">
            <h3 style="color: white; font-size: 18px;">üí∞ Customer Acquisition Cost (CAC)</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <div class="metric-value" id="cacValue" style="color: white; font-size: 48px;">$0</div>
                    <div id="cacEfficiency" style="font-size: 14px; margin-top: 10px;">Calculating efficiency...</div>
                </div>
                <div style="padding-top: 10px;">
                    <div style="font-size: 14px; opacity: 0.95; line-height: 1.8;">
                        <div><strong>Aura Pricing:</strong></div>
                        <div>Monthly: $12.99</div>
                        <div>Annual: $99.99</div>
                        <div id="cacLtvRatio" style="margin-top: 10px; font-weight: bold;">CAC:LTV Ratio: --</div>
                        <div id="breakeven" style="font-size: 12px;">Months to break-even: --</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="dashboard-grid">
            <div class="metric-card">
                <h3>ROI</h3>
                <div class="metric-value" id="roiValue">0%</div>
                <div class="metric-change" id="roiChange">Starting...</div>
            </div>
            
            <div class="metric-card">
                <h3>Conversions</h3>
                <div class="metric-value" id="conversionsValue">0</div>
                <div class="metric-change" id="cpaValue">CPA: $0</div>
            </div>
            
            <div class="metric-card">
                <h3>Win Rate</h3>
                <div class="metric-value" id="winRateValue">0%</div>
                <div class="metric-change">Last 20 auctions</div>
            </div>
            
            <div class="metric-card">
                <h3>Total Spend</h3>
                <div class="metric-value" id="spendValue">$0</div>
                <div class="metric-change" id="revenueValue">Revenue: $0</div>
            </div>
        </div>
        
        <div class="chart-container">
            <h3>üìà Real-Time Performance</h3>
            <canvas id="performanceChart"></canvas>
        </div>
        
        <div class="chart-container">
            <h3>üí∞ CAC Trend Analysis</h3>
            <canvas id="cacChart"></canvas>
        </div>
        
        <div class="dashboard-grid">
            <div class="chart-container">
                <h3>üé∞ Thompson Sampling Arms</h3>
                <div class="thompson-arms" id="thompsonArms">
                    <!-- Arms will be populated here -->
                </div>
            </div>
            
            <div class="chart-container">
                <h3>üë• Segment Performance</h3>
                <div class="segments-grid" id="segmentPerformance">
                    <!-- Segments will be populated here -->
                </div>
            </div>
        </div>
        
        <div class="event-log">
            <h3>üìã Event Log</h3>
            <div id="eventLog">
                <!-- Events will be populated here -->
            </div>
        </div>
    </div>
    
    <script>
        let chart = null;
        let updateInterval = null;
        
        // Initialize performance chart
        const ctx = document.getElementById('performanceChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'ROI %',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: '#667eea20',
                        yAxisID: 'y',
                        tension: 0.4
                    },
                    {
                        label: 'Win Rate %',
                        data: [],
                        borderColor: '#48bb78',
                        backgroundColor: '#48bb7820',
                        yAxisID: 'y',
                        tension: 0.4
                    },
                    {
                        label: 'Avg Bid $',
                        data: [],
                        borderColor: '#f6ad55',
                        backgroundColor: '#f6ad5520',
                        yAxisID: 'y1',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Percentage'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Bid Amount ($)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        }
                    }
                }
            }
        });
        
        // Initialize CAC trend chart
        const cacCtx = document.getElementById('cacChart').getContext('2d');
        const cacChart = new Chart(cacCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'CAC ($)',
                        data: [],
                        borderColor: '#f56565',
                        backgroundColor: '#f5656520',
                        borderWidth: 3,
                        tension: 0.4
                    },
                    {
                        label: 'Aura Annual Price',
                        data: [],
                        borderColor: '#48bb78',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        pointRadius: 0
                    },
                    {
                        label: 'Target CAC (33% LTV)',
                        data: [],
                        borderColor: '#f6ad55',
                        borderDash: [10, 5],
                        borderWidth: 2,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Customer Acquisition Cost Over Time'
                    },
                    legend: {
                        display: true
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        title: {
                            display: true,
                            text: 'Cost ($)'
                        },
                        min: 0
                    }
                }
            }
        });
        
        // Track CAC history
        const cacHistory = [];
        
        async function updateDashboard() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // Update status
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                if (data.is_running) {
                    statusDot.className = 'status-dot running';
                    statusText.textContent = 'System Running';
                } else {
                    statusDot.className = 'status-dot stopped';
                    statusText.textContent = 'System Stopped';
                }
                
                // Update episode count
                document.getElementById('episodeCount').textContent = `Episode: ${data.episode_count}`;
                
                // Update metrics
                document.getElementById('roiValue').textContent = data.metrics.current_roi.toFixed(1) + '%';
                document.getElementById('conversionsValue').textContent = data.metrics.total_conversions;
                document.getElementById('winRateValue').textContent = data.metrics.win_rate.toFixed(1) + '%';
                document.getElementById('spendValue').textContent = '$' + data.metrics.total_spend.toFixed(2);
                document.getElementById('revenueValue').textContent = 'Revenue: $' + data.metrics.total_revenue.toFixed(2);
                document.getElementById('cpaValue').textContent = 'CPA: $' + data.metrics.current_cpa.toFixed(2);
                
                // Calculate and update CAC
                const auraMonthlyPrice = 12.99;
                const auraAnnualPrice = 99.99;
                const auraLTV = auraAnnualPrice * 2; // 2-year average customer lifetime
                
                let cac = 0;
                if (data.metrics.total_conversions > 0) {
                    cac = data.metrics.total_spend / data.metrics.total_conversions;
                }
                
                document.getElementById('cacValue').textContent = '$' + cac.toFixed(2);
                
                // CAC efficiency status
                const cacEfficiency = document.getElementById('cacEfficiency');
                const cacLtvRatio = document.getElementById('cacLtvRatio');
                const breakeven = document.getElementById('breakeven');
                
                if (cac > 0) {
                    const ratio = cac / auraLTV;
                    const monthsToBreakeven = cac / auraMonthlyPrice;
                    
                    cacLtvRatio.textContent = `CAC:LTV Ratio: ${(ratio * 100).toFixed(1)}%`;
                    breakeven.textContent = `Months to break-even: ${monthsToBreakeven.toFixed(1)}`;
                    
                    if (ratio < 0.33) {
                        cacEfficiency.innerHTML = '‚úÖ EXCELLENT (CAC < 33% of LTV)';
                        cacEfficiency.style.color = '#48bb78';
                    } else if (ratio < 0.5) {
                        cacEfficiency.innerHTML = 'üü° GOOD (CAC < 50% of LTV)';
                        cacEfficiency.style.color = '#f6e05e';
                    } else {
                        cacEfficiency.innerHTML = '‚ö†Ô∏è NEEDS OPTIMIZATION (CAC > 50% of LTV)';
                        cacEfficiency.style.color = '#fff5f5';
                    }
                    
                    // Update CAC trend chart
                    if (data.time_series && data.time_series.timestamps.length > 0) {
                        cacHistory.push(cac);
                        const timestamps = data.time_series.timestamps.slice(-30);
                        const labels = timestamps.map(ts => {
                            const date = new Date(ts);
                            return date.toLocaleTimeString();
                        });
                        
                        cacChart.data.labels = labels;
                        
                        // CAC values
                        const cacData = cacHistory.slice(-30);
                        while (cacData.length < labels.length) {
                            cacData.unshift(0);
                        }
                        cacChart.data.datasets[0].data = cacData;
                        
                        // Reference lines
                        cacChart.data.datasets[1].data = new Array(labels.length).fill(auraAnnualPrice);
                        cacChart.data.datasets[2].data = new Array(labels.length).fill(auraLTV * 0.33);
                        
                        cacChart.update();
                    }
                } else {
                    cacEfficiency.textContent = 'No conversions yet - gathering data...';
                }
                
                // Update ROI change indicator
                const roiChange = document.getElementById('roiChange');
                if (data.metrics.current_roi > 0) {
                    roiChange.className = 'metric-change positive';
                    roiChange.textContent = '‚Üë Profitable';
                } else {
                    roiChange.className = 'metric-change negative';
                    roiChange.textContent = '‚Üì Learning...';
                }
                
                // Update chart
                if (data.time_series && data.time_series.timestamps.length > 0) {
                    const labels = data.time_series.timestamps.slice(-30).map(ts => {
                        const date = new Date(ts);
                        return date.toLocaleTimeString();
                    });
                    
                    chart.data.labels = labels;
                    
                    // Calculate ROI series
                    const roiSeries = [];
                    let cumulativeSpend = 0;
                    let cumulativeRevenue = 0;
                    for (let i = 0; i < data.time_series.timestamps.length; i++) {
                        cumulativeSpend += data.time_series.bids[i] || 0;
                        if (data.time_series.win_rate[i]) {
                            cumulativeRevenue += Math.random() * 10; // Simulated
                        }
                        const roi = cumulativeSpend > 0 ? ((cumulativeRevenue - cumulativeSpend) / cumulativeSpend * 100) : 0;
                        roiSeries.push(roi);
                    }
                    
                    chart.data.datasets[0].data = roiSeries.slice(-30);
                    
                    // Win rate (moving average)
                    const winRateSeries = [];
                    for (let i = 0; i < data.time_series.win_rate.length; i++) {
                        const start = Math.max(0, i - 10);
                        const slice = data.time_series.win_rate.slice(start, i + 1);
                        const avg = slice.reduce((a, b) => a + b, 0) / slice.length * 100;
                        winRateSeries.push(avg);
                    }
                    chart.data.datasets[1].data = winRateSeries.slice(-30);
                    
                    // Bids
                    chart.data.datasets[2].data = data.time_series.bids.slice(-30);
                    
                    chart.update();
                }
                
                // Update Thompson arms
                const armsContainer = document.getElementById('thompsonArms');
                armsContainer.innerHTML = '';
                for (const [name, stats] of Object.entries(data.arm_stats || {})) {
                    const armCard = document.createElement('div');
                    armCard.className = 'arm-card';
                    armCard.innerHTML = `
                        <div class="arm-name">${name}</div>
                        <div class="arm-value">${stats.value.toFixed(3)}</div>
                        <div class="arm-bar">
                            <div class="arm-bar-fill" style="width: ${stats.value * 100}%"></div>
                        </div>
                    `;
                    armsContainer.appendChild(armCard);
                }
                
                // Update segments
                const segmentsContainer = document.getElementById('segmentPerformance');
                segmentsContainer.innerHTML = '';
                for (const [segment, stats] of Object.entries(data.segment_performance || {})) {
                    const roi = stats.spend > 0 ? ((stats.revenue - stats.spend) / stats.spend * 100) : 0;
                    const segmentCard = document.createElement('div');
                    segmentCard.className = 'segment-card';
                    segmentCard.innerHTML = `
                        <div class="segment-name">${segment}</div>
                        <div class="segment-stat">
                            <span>Conversions:</span>
                            <strong>${stats.conversions}</strong>
                        </div>
                        <div class="segment-stat">
                            <span>Revenue:</span>
                            <strong>$${stats.revenue.toFixed(0)}</strong>
                        </div>
                        <div class="segment-stat">
                            <span>ROI:</span>
                            <strong>${roi.toFixed(0)}%</strong>
                        </div>
                    `;
                    segmentsContainer.appendChild(segmentCard);
                }
                
                // Update event log
                const eventLogContainer = document.getElementById('eventLog');
                eventLogContainer.innerHTML = '';
                for (const event of (data.event_log || []).reverse()) {
                    const eventItem = document.createElement('div');
                    eventItem.className = `event-item ${event.type}`;
                    const time = new Date(event.timestamp).toLocaleTimeString();
                    eventItem.innerHTML = `
                        <span class="event-time">${time}</span>
                        ${event.message}
                    `;
                    eventLogContainer.appendChild(eventItem);
                }
                
            } catch (error) {
                console.error('Error updating dashboard:', error);
            }
        }
        
        async function startSystem() {
            await fetch('/api/start', { method: 'POST' });
            updateDashboard();
        }
        
        async function stopSystem() {
            await fetch('/api/stop', { method: 'POST' });
            updateDashboard();
        }
        
        async function resetSystem() {
            if (confirm('Reset all metrics and start fresh?')) {
                await fetch('/api/reset', { method: 'POST' });
                setTimeout(() => {
                    startSystem();
                }, 1000);
            }
        }
        
        // Start automatic updates
        updateDashboard();
        updateInterval = setInterval(updateDashboard, 1000);
        
        // Auto-start the system after page load
        setTimeout(() => {
            startSystem();
        }, 1000);
    </script>
</body>
</html>